<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fechamento de Caixa - Com√©rcio de √Ågua e G√°s</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .result-card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
        }
        /* Tooltip Styles */
        .tooltip-icon {
            display: inline-block;
            margin-left: 6px;
            background-color: #4b5563; /* bg-gray-600 */
            color: #d1d5db; /* text-gray-300 */
            width: 16px;
            height: 16px;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .tooltip-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%; 
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937; /* bg-gray-800 */
            color: #e5e7eb; /* text-gray-200 */
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #4b5563; /* border-gray-600 */
            font-size: 12px;
            line-height: 1.4;
            font-weight: normal;
            white-space: normal; 
            width: 240px; 
            text-align: left;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            z-index: 10;
        }

        .tooltip-icon::before {
            content: '';
            position: absolute;
            bottom: 130%;
            margin-bottom: -5px; 
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: #4b5563 transparent transparent transparent; 
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            z-index: 11;
        }

        .tooltip-icon:hover::after,
        .tooltip-icon:hover::before {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Fechamento de Caixa Mensal</h1>
            <p class="text-gray-400 mt-2">Distribuidora de √Ågua e G√°s</p>
        </header>

        <main>
            <!-- Form for data input -->
            <form id="cash-form" class="space-y-8">
                <!-- Water Section -->
                <fieldset class="border border-gray-700 p-6 rounded-lg">
                    <legend class="text-xl font-semibold px-2 text-cyan-400">üíß √Ågua Mineral</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                        <div>
                            <label for="initial-stock-water" class="block text-sm font-medium text-gray-300 mb-1">Estoque Inicial (unid.)<span class="tooltip-icon" data-tooltip="Digite a quantidade de unidades que sobraram do m√™s anterior. Este valor √© o ponto de partida para o c√°lculo de vendas.">?</span></label>
                            <input type="number" id="initial-stock-water" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ex: 100">
                        </div>
                        <div>
                            <label for="entries-water" class="block text-sm font-medium text-gray-300 mb-1">Entradas no M√™s (unid.)<span class="tooltip-icon" data-tooltip="Informe o total de unidades compradas e recebidas durante o m√™s. Isso ser√° somado ao estoque inicial.">?</span></label>
                            <input type="number" id="entries-water" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ex: 500">
                        </div>
                        <div>
                            <label for="remaining-water" class="block text-sm font-medium text-gray-300 mb-1">Restante no Fim (unid.)<span class="tooltip-icon" data-tooltip="Digite a quantidade de unidades que sobraram no estoque ao final do m√™s, ap√≥s todas as vendas.">?</span></label>
                            <input type="number" id="remaining-water" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ex: 80">
                        </div>
                        <div>
                            <label for="sold-water" class="block text-sm font-medium text-gray-300 mb-1">Vendido no M√™s (opcional)<span class="tooltip-icon" data-tooltip="Este campo √© opcional. O sistema ir√° calcular a quantidade vendida usando a f√≥rmula: Estoque Inicial + Entradas - Restante.">?</span></label>
                            <input type="number" id="sold-water" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ser√° recalculado">
                        </div>
                        <div>
                            <label for="price-water" class="block text-sm font-medium text-gray-300 mb-1">Pre√ßo Venda<span class="tooltip-icon" data-tooltip="Informe o pre√ßo final de venda por unidade. Usado para calcular o 'Faturamento Esperado'.">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="price-water" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="10.00">
                            </div>
                        </div>
                        <div>
                            <label for="cost-water" class="block text-sm font-medium text-gray-300 mb-1">Custo Compra<span class="tooltip-icon" data-tooltip="Informe o custo de compra por unidade. Usado para calcular o valor do seu estoque.">?</span></label>
                             <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="cost-water" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="5.50">
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Gas Section -->
                <fieldset class="border border-gray-700 p-6 rounded-lg">
                    <legend class="text-xl font-semibold px-2 text-orange-400">üî• Botij√£o de G√°s</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                        <div>
                            <label for="initial-stock-gas" class="block text-sm font-medium text-gray-300 mb-1">Estoque Inicial (unid.)<span class="tooltip-icon" data-tooltip="Digite a quantidade de unidades que sobraram do m√™s anterior. Este valor √© o ponto de partida para o c√°lculo de vendas.">?</span></label>
                            <input type="number" id="initial-stock-gas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Ex: 50">
                        </div>
                        <div>
                            <label for="entries-gas" class="block text-sm font-medium text-gray-300 mb-1">Entradas no M√™s (unid.)<span class="tooltip-icon" data-tooltip="Informe o total de unidades compradas e recebidas durante o m√™s. Isso ser√° somado ao estoque inicial.">?</span></label>
                            <input type="number" id="entries-gas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Ex: 200">
                        </div>
                        <div>
                            <label for="remaining-gas" class="block text-sm font-medium text-gray-300 mb-1">Restante no Fim (unid.)<span class="tooltip-icon" data-tooltip="Digite a quantidade de unidades que sobraram no estoque ao final do m√™s, ap√≥s todas as vendas.">?</span></label>
                            <input type="number" id="remaining-gas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Ex: 40">
                        </div>
                        <div>
                            <label for="sold-gas" class="block text-sm font-medium text-gray-300 mb-1">Vendido no M√™s (opcional)<span class="tooltip-icon" data-tooltip="Este campo √© opcional. O sistema ir√° calcular a quantidade vendida usando a f√≥rmula: Estoque Inicial + Entradas - Restante.">?</span></label>
                            <input type="number" id="sold-gas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Ser√° recalculado">
                        </div>
                        <div>
                            <label for="price-gas" class="block text-sm font-medium text-gray-300 mb-1">Pre√ßo Venda<span class="tooltip-icon" data-tooltip="Informe o pre√ßo final de venda por unidade. Usado para calcular o 'Faturamento Esperado'.">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="price-gas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="110.00">
                            </div>
                        </div>
                         <div>
                            <label for="cost-gas" class="block text-sm font-medium text-gray-300 mb-1">Custo Compra<span class="tooltip-icon" data-tooltip="Informe o custo de compra por unidade. Usado para calcular o valor do seu estoque.">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="cost-gas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="85.00">
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Financial Section -->
                 <fieldset class="border border-gray-700 p-6 rounded-lg">
                    <legend class="text-xl font-semibold px-2 text-emerald-400">üí∞ Financeiro</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                        <div>
                            <label for="total-revenue" class="block text-sm font-medium text-gray-300 mb-1">Faturamento Informado<span class="tooltip-icon" data-tooltip="Digite o valor total de todas as vendas registradas no seu sistema ou planilha durante o m√™s. Ser√° comparado com o 'Faturamento Esperado'.">?</span></label>
                             <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="total-revenue" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="25000.00">
                            </div>
                        </div>
                        <div>
                            <label for="cash-in" class="block text-sm font-medium text-gray-300 mb-1">Entradas em Caixa<span class="tooltip-icon" data-tooltip="Informe todo o dinheiro que efetivamente entrou no caixa (dinheiro, pix, cart√£o). Pode ser diferente do faturamento se houver vendas a prazo.">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="cash-in" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="24500.00">
                            </div>
                        </div>
                        <div>
                            <label for="expenses-paid" class="block text-sm font-medium text-gray-300 mb-1">Despesas Pagas<span class="tooltip-icon" data-tooltip="Some todas as despesas que foram pagas durante o m√™s (aluguel, sal√°rios, fornecedores, etc.).">?</span></label>
                             <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="expenses-paid" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="2000.00">
                            </div>
                        </div>
                        <div>
                            <label for="cash-on-hand" class="block text-sm font-medium text-gray-300 mb-1">Dinheiro em M√£os no Fim<span class="tooltip-icon" data-tooltip="Informe o valor total em dinheiro f√≠sico e em contas no final do m√™s. Ser√° comparado com o caixa calculado (Entradas - Despesas Pagas).">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="cash-on-hand" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="22500.00">
                            </div>
                        </div>
                         <div>
                            <label for="expenses-to-pay" class="block text-sm font-medium text-gray-300 mb-1">Despesas a Pagar<span class="tooltip-icon" data-tooltip="Liste as despesas do m√™s que ainda n√£o foram pagas e vencer√£o em breve.">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="expenses-to-pay" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="500.00">
                            </div>
                        </div>
                        <div>
                            <label for="notas-recebidas" class="block text-sm font-medium text-gray-300 mb-1">Notas Recebidas<span class="tooltip-icon" data-tooltip="Informe o valor total das notas fiscais de compra de mercadorias (√°gua, g√°s, etc.) que voc√™ recebeu de fornecedores durante este m√™s.">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="notas-recebidas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="15000.00">
                            </div>
                        </div>
                        <div>
                            <label for="notas-acumuladas" class="block text-sm font-medium text-gray-300 mb-1">Notas Acumuladas no M√™s<span class="tooltip-icon" data-tooltip="Valor total de notas fiscais de fornecedores que est√£o em aberto para pagamento, somando as notas deste m√™s com as de meses anteriores.">?</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-400 sm:text-sm">R$</span>
                                </div>
                                <input type="number" step="0.01" id="notas-acumuladas" class="w-full bg-gray-800 border-gray-600 rounded-md p-2 pl-10 text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="15500.00">
                            </div>
                        </div>
                    </div>
                </fieldset>
                
                <div class="text-center">
                    <button type="button" id="calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        Fechar Caixa
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <div id="results-section" class="hidden mt-10 space-y-6">
                <div id="status-card" class="result-card text-center p-6">
                    <h2 class="text-2xl font-bold" id="status-title"></h2>
                    <p class="text-gray-400 mt-2" id="status-subtitle"></p>
                    <div id="inconsistencies-list" class="mt-4 text-left text-sm space-y-2"></div>
                </div>

                <!-- AI Analysis Button and Card -->
                <div id="ai-analysis-container" class="hidden text-center">
                    <button type="button" id="ai-analysis-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        ‚ú® Obter An√°lise e Dicas com IA
                    </button>
                </div>

                <div id="ai-analysis-card" class="hidden result-card">
                     <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-purple-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                        An√°lise da IA
                    </h3>
                    <div id="ai-analysis-content" class="text-gray-300 space-y-4">
                        <!-- AI content will be injected here -->
                    </div>
                </div>


                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Sales Summary -->
                    <div class="result-card space-y-3">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Resumo de Vendas</h3>
                        <p class="flex justify-between"><span>Total Vendido (Calculado):<span class="tooltip-icon" data-tooltip="Valor total que deveria ter sido faturado com base na quantidade de produtos vendidos e o pre√ßo de venda.">?</span></span> <span class="font-mono" id="total-sold"></span></p>
                        <p class="flex justify-between"><span>Faturamento Esperado:<span class="tooltip-icon" data-tooltip="Representa a receita ideal com base no seu controle de estoque. √â o mesmo que 'Total Vendido'.">?</span></span> <span class="font-mono" id="expected-revenue"></span></p>
                        <p class="flex justify-between"><span>Faturamento Informado:<span class="tooltip-icon" data-tooltip="Este √© o valor total de vendas que voc√™ inseriu manualmente. Deve ser pr√≥ximo do 'Faturamento Esperado'.">?</span></span> <span class="font-mono" id="reported-revenue"></span></p>
                        <p class="flex justify-between font-bold"><span>Diferen√ßa Faturamento:<span class="tooltip-icon" data-tooltip="Mostra se o seu faturamento informado foi maior (positivo) ou menor (negativo) que o esperado. Diferen√ßas negativas podem indicar perdas ou erros de registro.">?</span></span> <span class="font-mono" id="revenue-diff"></span></p>
                    </div>

                    <!-- Cash Summary -->
                    <div class="result-card space-y-3">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Resumo de Caixa</h3>
                        <p class="flex justify-between"><span>Dinheiro Dispon√≠vel (Calc.):<span class="tooltip-icon" data-tooltip="Resultado de 'Entradas em Caixa - Despesas Pagas'. √â o valor que, teoricamente, deveria estar no seu caixa.">?</span></span> <span class="font-mono" id="available-cash"></span></p>
                        <p class="flex justify-between"><span>Dinheiro em M√£os (Inf.):<span class="tooltip-icon" data-tooltip="O valor que voc√™ informou ter contado no caixa. Deve ser igual ao 'Dinheiro Dispon√≠vel'.">?</span></span> <span class="font-mono" id="on-hand-cash"></span></p>
                        <p class="flex justify-between font-bold"><span>Diferen√ßa em Dinheiro:<span class="tooltip-icon" data-tooltip="Mostra se faltou (negativo) ou sobrou (positivo) dinheiro no seu caixa. O ideal √© que seja zero.">?</span></span> <span class="font-mono" id="cash-diff"></span></p>
                        <p class="flex justify-between pt-2 border-t border-gray-600"><span>Vendas vs Entradas:<span class="tooltip-icon" data-tooltip="Compara o dinheiro que entrou com o faturamento do m√™s. Negativo = menos dinheiro entrou (vendas a prazo). Positivo = mais dinheiro entrou (d√≠vidas antigas recebidas, etc.).">?</span></span> <span class="font-mono" id="sales-vs-cashin"></span></p>
                    </div>

                    <!-- Stock Summary -->
                    <div class="result-card space-y-3">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Resumo de Estoque</h3>
                        <p class="flex justify-between"><span>Valor do Estoque Inicial:<span class="tooltip-icon" data-tooltip="O custo total das mercadorias que voc√™ tinha no in√≠cio do m√™s (baseado no pre√ßo de compra).">?</span></span> <span class="font-mono" id="initial-stock-value"></span></p>
                        <p class="flex justify-between"><span>Valor do Estoque Final:<span class="tooltip-icon" data-tooltip="O custo total das mercadorias que sobraram no final do m√™s. Mostra o capital que voc√™ tem investido em produtos.">?</span></span> <span class="font-mono" id="final-stock-value"></span></p>
                        <p class="flex justify-between font-bold text-green-400"><span>Valor Potencial do Estoque:<span class="tooltip-icon" data-tooltip="O valor total que voc√™ pode faturar se vender todo o seu estoque final pelo pre√ßo de venda atual. √â uma proje√ß√£o de receita futura.">?</span></span> <span class="font-mono" id="potential-stock-value"></span></p>
                    </div>

                    <!-- Financial Health -->
                    <div class="result-card space-y-3">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Sa√∫de Financeira</h3>
                         <p class="flex justify-between"><span>Entradas em Caixa:<span class="tooltip-icon" data-tooltip="O montante total de dinheiro que entrou no seu neg√≥cio durante o m√™s.">?</span></span> <span class="font-mono" id="health-cash-in"></span></p>
                         <p class="flex justify-between"><span>Total de Despesas (Pagas + Pagar):<span class="tooltip-icon" data-tooltip="A soma de todas as suas obriga√ß√µes financeiras do m√™s, tanto as que j√° foram quitadas quanto as pendentes.">?</span></span> <span class="font-mono" id="health-total-expenses"></span></p>
                         <p class="flex justify-between font-bold"><span>Situa√ß√£o de Pagamentos:<span class="tooltip-icon" data-tooltip="'OK' significa que as entradas foram suficientes para cobrir todas as despesas. 'Alerta' indica que o dinheiro que entrou n√£o foi o bastante para pagar todas as contas do m√™s.">?</span></span> <span class="font-mono" id="health-status"></span></p>
                    </div>

                    <!-- Invoice Summary -->
                    <div class="result-card space-y-3 md:col-span-2">
                        <h3 class="text-lg font-semibold text-white border-b border-gray-700 pb-2">Resumo de Notas Fiscais</h3>
                         <p class="flex justify-between"><span>Notas Recebidas no M√™s:<span class="tooltip-icon" data-tooltip="Valor total das notas fiscais de compra de mercadoria recebidas de fornecedores este m√™s.">?</span></span> <span class="font-mono" id="result-notas-recebidas"></span></p>
                         <p class="flex justify-between"><span>Total de Notas Acumuladas:<span class="tooltip-icon" data-tooltip="D√≠vida total com fornecedores (notas em aberto), somando as notas do m√™s com saldos anteriores.">?</span></span> <span class="font-mono" id="result-notas-acumuladas"></span></p>
                    </div>
                </div>

                <div class="text-center pt-4">
                     <button type="button" id="pdf-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        Gerar PDF
                    </button>
                </div>
            </div>
        </main>
        
        <footer class="text-center text-gray-500 mt-12 pb-4 text-sm">
            <p>&copy; 2024 - Sistema de Fechamento de Caixa. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        // Store results globally to be accessible by PDF generation function
        let calculatedResults = {};

        // Helper function to format numbers as Brazilian currency
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };
        
        // Helper function to parse input values, defaulting to 0 if empty or invalid
        const getNum = (id) => parseFloat(document.getElementById(id).value) || 0;

        // Main calculation logic
        document.getElementById('calculate-btn').addEventListener('click', () => {
            // --- Get Water Data ---
            const initialStockWater = getNum('initial-stock-water');
            const entriesWater = getNum('entries-water');
            const remainingWater = getNum('remaining-water');
            const priceWater = getNum('price-water');
            const costWater = getNum('cost-water');

            // --- Get Gas Data ---
            const initialStockGas = getNum('initial-stock-gas');
            const entriesGas = getNum('entries-gas');
            const remainingGas = getNum('remaining-gas');
            const priceGas = getNum('price-gas');
            const costGas = getNum('cost-gas');
            
            // --- Get Financial Data ---
            const totalRevenue = getNum('total-revenue');
            const cashIn = getNum('cash-in');
            const expensesPaid = getNum('expenses-paid');
            const cashOnHand = getNum('cash-on-hand');
            const expensesToPay = getNum('expenses-to-pay');
            const notasRecebidas = getNum('notas-recebidas');
            const notasAcumuladas = getNum('notas-acumuladas');

            // --- Calculations ---
            const soldWater = initialStockWater + entriesWater - remainingWater;
            const soldGas = initialStockGas + entriesGas - remainingGas;
            
            document.getElementById('sold-water').value = soldWater;
            document.getElementById('sold-gas').value = soldGas;

            const expectedRevenueWater = soldWater * priceWater;
            const expectedRevenueGas = soldGas * priceGas;
            const totalExpectedRevenue = expectedRevenueWater + expectedRevenueGas;

            const revenueDiff = totalRevenue - totalExpectedRevenue;
            
            const availableCash = cashIn - expensesPaid;
            const cashDiff = cashOnHand - availableCash;
            
            const canPayAllExpenses = cashIn >= (expensesPaid + expensesToPay);

            const initialStockValue = (initialStockWater * costWater) + (initialStockGas * costGas);
            const finalStockValue = (remainingWater * costWater) + (remainingGas * costGas);
            const potentialStockValue = (remainingWater * priceWater) + (remainingGas * priceGas);
            
            const salesVsCashinDiff = cashIn - totalRevenue;

            // --- Inconsistency Checks ---
            let inconsistencies = [];
            if (Math.abs(revenueDiff) > 0.01) {
                inconsistencies.push(`Diferen√ßa de ${formatCurrency(revenueDiff)} entre o faturamento esperado e o informado.`);
            }
            if (Math.abs(cashDiff) > 0.01) {
                inconsistencies.push(`Diferen√ßa de ${formatCurrency(cashDiff)} entre o dinheiro em m√£os e o caixa calculado.`);
            }
            if (!canPayAllExpenses) {
                inconsistencies.push(`As entradas em caixa n√£o s√£o suficientes para cobrir todas as despesas (pagas e a pagar).`);
            }
            if (salesVsCashinDiff < -0.01) {
                inconsistencies.push(`Diferen√ßa de ${formatCurrency(salesVsCashinDiff)} entre o faturado e o que entrou no caixa (vendas a prazo?).`);
            } else if (salesVsCashinDiff > 0.01) {
                inconsistencies.push(`Entrou ${formatCurrency(salesVsCashinDiff)} a mais no caixa do que o faturado (recebimento de d√≠vidas antigas?).`);
            }
            
            const isSuccess = inconsistencies.length === 0;

            // --- Store results for PDF generation ---
            calculatedResults = {
                soldWater, soldGas, totalExpectedRevenue, totalRevenue, revenueDiff,
                availableCash, cashOnHand, cashDiff,
                initialStockValue, finalStockValue, potentialStockValue,
                cashIn, totalExpenses: expensesPaid + expensesToPay, canPayAllExpenses,
                salesVsCashinDiff,
                isSuccess, inconsistencies,
                notasRecebidas, notasAcumuladas
            };
            
            // --- Display Results ---
            const resultsSection = document.getElementById('results-section');
            resultsSection.classList.remove('hidden');

            // Show AI Button and reset AI card
            document.getElementById('ai-analysis-container').classList.remove('hidden');
            const aiCard = document.getElementById('ai-analysis-card');
            aiCard.classList.add('hidden');
            document.getElementById('ai-analysis-content').innerHTML = '';

            // Status Card
            const statusTitle = document.getElementById('status-title');
            const statusSubtitle = document.getElementById('status-subtitle');
            const statusCard = document.getElementById('status-card');
            const inconsistenciesDiv = document.getElementById('inconsistencies-list');
            
            inconsistenciesDiv.innerHTML = '';
            
            if (isSuccess) {
                statusTitle.textContent = 'Caixa Fechou no Verde!';
                statusTitle.className = 'text-2xl font-bold text-green-400';
                statusSubtitle.textContent = 'Parab√©ns! Todas as contas e o estoque est√£o consistentes.';
                statusCard.classList.remove('border-red-500');
                statusCard.classList.add('border-green-500');
            } else {
                statusTitle.textContent = 'Caixa Fechou no Vermelho!';
                statusTitle.className = 'text-2xl font-bold text-red-400';
                statusSubtitle.textContent = 'Foram encontradas as seguintes inconsist√™ncias:';
                statusCard.classList.remove('border-green-500');
                statusCard.classList.add('border-red-500');
                inconsistencies.forEach(msg => {
                    const p = document.createElement('p');
                    p.innerHTML = `üî¥ <span class="ml-2">${msg}</span>`;
                    p.className = 'p-2 bg-gray-700/50 rounded-md';
                    inconsistenciesDiv.appendChild(p);
                });
            }

            // Sales Summary
            document.getElementById('total-sold').textContent = formatCurrency(totalExpectedRevenue);
            document.getElementById('expected-revenue').textContent = formatCurrency(totalExpectedRevenue);
            document.getElementById('reported-revenue').textContent = formatCurrency(totalRevenue);
            const revenueDiffEl = document.getElementById('revenue-diff');
            revenueDiffEl.textContent = formatCurrency(revenueDiff);
            revenueDiffEl.className = revenueDiff !== 0 ? 'text-red-400 font-mono' : 'text-green-400 font-mono';
            
            // Cash Summary
            document.getElementById('available-cash').textContent = formatCurrency(availableCash);
            document.getElementById('on-hand-cash').textContent = formatCurrency(cashOnHand);
            const cashDiffEl = document.getElementById('cash-diff');
            cashDiffEl.textContent = formatCurrency(cashDiff);
            cashDiffEl.className = cashDiff !== 0 ? 'text-red-400 font-mono' : 'text-green-400 font-mono';
            
            const salesVsCashinEl = document.getElementById('sales-vs-cashin');
            salesVsCashinEl.textContent = formatCurrency(salesVsCashinDiff);
             if(salesVsCashinDiff > 0.01) {
                salesVsCashinEl.className = 'font-mono text-cyan-400'; // Positive difference is informational (light blue)
            } else if (salesVsCashinDiff < -0.01) {
                salesVsCashinEl.className = 'font-mono text-amber-400'; // Negative difference is a warning (amber)
            } else {
                salesVsCashinEl.className = 'font-mono'; // Neutral
            }


            // Stock Summary
            document.getElementById('initial-stock-value').textContent = formatCurrency(initialStockValue);
            document.getElementById('final-stock-value').textContent = formatCurrency(finalStockValue);
            document.getElementById('potential-stock-value').textContent = formatCurrency(potentialStockValue);
            
            // Health Summary
            document.getElementById('health-cash-in').textContent = formatCurrency(cashIn);
            document.getElementById('health-total-expenses').textContent = formatCurrency(expensesPaid + expensesToPay);
            const healthStatusEl = document.getElementById('health-status');
            healthStatusEl.textContent = canPayAllExpenses ? 'OK' : 'Alerta';
            healthStatusEl.className = canPayAllExpenses ? 'text-green-400 font-mono' : 'text-red-400 font-mono';

            // Invoice Summary
            document.getElementById('result-notas-recebidas').textContent = formatCurrency(notasRecebidas);
            document.getElementById('result-notas-acumuladas').textContent = formatCurrency(notasAcumuladas);

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        });

        // PDF Generation logic
        document.getElementById('pdf-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            if (Object.keys(calculatedResults).length === 0) {
                alert('Por favor, primeiro clique em "Fechar Caixa" para calcular os resultados.');
                return;
            }

            const doc = new jsPDF();

            // This helper function was missing and is now defined.
            const drawSection = (title, data, startY) => {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.text(title, 20, startY);
                
                let currentY = startY + 8;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                
                data.forEach(([label, value]) => {
                    doc.text(label, 25, currentY);
                    doc.text(String(value), 190, currentY, { align: 'right' });
                    currentY += 7;
                });
                
                return currentY + 5; // Add padding for the next section
            };

            // --- Header ---
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Relat√≥rio de Fechamento de Caixa', 105, 20, { align: 'center' });
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(`Per√≠odo: ${new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`, 105, 28, { align: 'center' });

            // --- Status ---
            let currentY = 45;
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            if (calculatedResults.isSuccess) {
                doc.setTextColor('#22c55e'); // green-500
                doc.text('Status: Caixa Fechou no Verde', 20, currentY);
            } else {
                doc.setTextColor('#ef4444'); // red-500
                doc.text('Status: Caixa Fechou no Vermelho', 20, currentY);
            }
            doc.setTextColor(0, 0, 0); // Reset color to black
            currentY += 10;

            if (!calculatedResults.isSuccess && calculatedResults.inconsistencies.length > 0) {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('Inconsist√™ncias Encontradas:', 20, currentY);
                currentY += 6;
                doc.setFont('helvetica', 'normal');
                calculatedResults.inconsistencies.forEach(msg => {
                    const cleanedMsg = msg.replace(/R\$\s/g, '');
                    const splitText = doc.splitTextToSize(cleanedMsg, 165); // Wrap text
                    doc.text(`- ${splitText}`, 25, currentY);
                    currentY += (splitText.length * 5);
                });
            }
            currentY += 5;

            // --- Data Sections ---
            const salesData = [
                ['Total Vendido (Calculado):', formatCurrency(calculatedResults.totalExpectedRevenue)],
                ['Faturamento Esperado:', formatCurrency(calculatedResults.totalExpectedRevenue)],
                ['Faturamento Informado:', formatCurrency(calculatedResults.totalRevenue)],
                ['Diferen√ßa Faturamento:', formatCurrency(calculatedResults.revenueDiff)],
            ];
            currentY = drawSection('Resumo de Vendas', salesData, currentY);

            const cashData = [
                ['Dinheiro Dispon√≠vel (Calc.):', formatCurrency(calculatedResults.availableCash)],
                ['Dinheiro em M√£os (Inf.):', formatCurrency(calculatedResults.cashOnHand)],
                ['Diferen√ßa em Dinheiro:', formatCurrency(calculatedResults.cashDiff)],
                ['Vendas vs Entradas:', formatCurrency(calculatedResults.salesVsCashinDiff)],
            ];
            currentY = drawSection('Resumo de Caixa', cashData, currentY);

            const stockData = [
                ['Valor do Estoque Inicial:', formatCurrency(calculatedResults.initialStockValue)],
                ['Valor do Estoque Final:', formatCurrency(calculatedResults.finalStockValue)],
                ['Valor Potencial do Estoque:', formatCurrency(calculatedResults.potentialStockValue)],
            ];
            currentY = drawSection('Resumo de Estoque', stockData, currentY);

            const healthData = [
                ['Entradas em Caixa:', formatCurrency(calculatedResults.cashIn)],
                ['Total de Despesas:', formatCurrency(calculatedResults.totalExpenses)],
                ['Situa√ß√£o de Pagamentos:', calculatedResults.canPayAllExpenses ? 'OK' : 'Alerta'],
            ];
            currentY = drawSection('Sa√∫de Financeira', healthData, currentY);

            const invoiceData = [
                ['Notas Recebidas no M√™s:', formatCurrency(calculatedResults.notasRecebidas)],
                ['Total de Notas Acumuladas:', formatCurrency(calculatedResults.notasAcumuladas)],
            ];
            currentY = drawSection('Resumo de Notas Fiscais', invoiceData, currentY);

            doc.save(`fechamento-caixa-${new Date().toISOString().slice(0, 10)}.pdf`);
        });

        // --- Gemini API Integration ---
        document.getElementById('ai-analysis-btn').addEventListener('click', getAiAnalysis);

        async function getAiAnalysis() {
            const aiCard = document.getElementById('ai-analysis-card');
            const aiContent = document.getElementById('ai-analysis-content');
            const aiButton = document.getElementById('ai-analysis-btn');

            // Show loading state
            aiCard.classList.remove('hidden');
            aiContent.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Analisando dados e gerando dicas...</span>
                </div>
            `;
            aiButton.disabled = true;
            aiButton.classList.add('opacity-50', 'cursor-not-allowed');

            const { isSuccess, inconsistencies, revenueDiff, cashDiff, salesVsCashinDiff, canPayAllExpenses } = calculatedResults;

            // Construct the prompt for the Gemini API
            const statusText = isSuccess ? "O caixa fechou no verde, sem inconsist√™ncias majorit√°rias." : "O caixa fechou no vermelho.";
            let inconsistenciesText = "Nenhuma inconsist√™ncia grave encontrada.";
            if (inconsistencies.length > 0) {
                inconsistenciesText = `Foram encontradas as seguintes inconsist√™ncias: ${inconsistencies.join(' ')}`;
            }

            const prompt = `
                Voc√™ √© um consultor de neg√≥cios especializado em pequenos com√©rcios no Brasil.
                Analise os seguintes dados de fechamento de caixa de uma distribuidora de √°gua e g√°s e forne√ßa uma resposta formatada em Markdown simples.
                A resposta deve ter duas se√ß√µes com t√≠tulos em negrito:
                1.  **An√°lise da Situa√ß√£o**: Um par√°grafo curto analisando a sa√∫de financeira do neg√≥cio este m√™s.
                2.  **Plano de A√ß√£o**: Uma lista numerada com 3 dicas pr√°ticas e acion√°veis para melhorar os resultados no pr√≥ximo m√™s, baseadas diretamente nos problemas identificados.

                Se o caixa fechou no verde, as dicas podem ser sobre otimiza√ß√£o. Se fechou no vermelho, as dicas devem focar em resolver os problemas.

                **Dados do Fechamento:**
                - **Status Geral:** ${statusText}
                - **Diferen√ßa de Faturamento (Esperado vs. Informado):** ${formatCurrency(revenueDiff)}
                - **Diferen√ßa de Caixa (Calculado vs. Em M√£os):** ${formatCurrency(cashDiff)}
                - **Diferen√ßa entre Vendas e Entradas no Caixa:** ${formatCSSurrency(salesVsCashinDiff)} (Pode indicar vendas a prazo)
                - **Capacidade de Pagar Despesas:** ${canPayAllExpenses ? 'Suficiente' : 'Insuficiente'}
                - **Resumo das Inconsist√™ncias:** ${inconsistenciesText}

                Seja direto, pr√°tico e use uma linguagem motivadora para um pequeno empres√°rio.
            `;

            const apiKey = ""; // API key will be provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}. Detalhes: ${errorBody}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    // Convert simple markdown to HTML
                    let html = text
                      .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white text-base">$1</strong>')
                      .replace(/(\n\s*\d\.\s)/g, '<br><br>$1') // Add space before numbered list items
                      .replace(/\n/g, '<br>');
                    aiContent.innerHTML = `<div class="text-gray-300 leading-relaxed">${html}</div>`;
                } else {
                    throw new Error("Resposta da IA inv√°lida ou vazia.");
                }

            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                aiContent.innerHTML = `
                    <div class="text-red-400 text-center p-4">
                        <p><strong>Ocorreu um erro ao buscar a an√°lise.</strong></p>
                        <p class="text-sm mt-2">Por favor, tente novamente mais tarde.</p>
                    </div>
                `;
            } finally {
                aiButton.disabled = false;
                aiButton.classList.remove('opacity-50', 'cursor-not-allowed');
                aiCard.scrollIntoView({ behavior: 'smooth' });
            }
        }
    </script>
</body>
</html>

